name: Publish Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write

env:
  RUST_TOOLCHAIN: stable
  MUSL_TARGET: x86_64-unknown-linux-musl

jobs:
  publish-release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Strip linuxbrew from PATH
        run: |
          CLEAN_PATH=$(printf '%s\n' "$PATH" | tr ':' '\n' | grep -v 'linuxbrew' | paste -sd: -)
          echo "PATH=$CLEAN_PATH" >> "$GITHUB_ENV"

      - name: Extract version from tag
        id: vars
        run: |
          TAG_NAME="${GITHUB_REF_NAME}"
          VERSION="${TAG_NAME#v}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Build all release artifacts (containerized)
        run: |
          make release-binary
          make release-rpm
          make release-deb
          make release-arch
          make release-alpine

      - name: Prepare binary filename
        run: |
          VERSION="${{ steps.vars.outputs.version }}"
          cp "target/${{ env.MUSL_TARGET }}/release/sanitize_filenames" \
             "sanitize_filenames-${VERSION}-${{ env.MUSL_TARGET }}"

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          files: |
            sanitize_filenames-${{ steps.vars.outputs.version }}-${{ env.MUSL_TARGET }}
            target/deb/sanitize-filenames_${{ steps.vars.outputs.version }}_amd64.deb
            target/archpkg/sanitize-filenames-${{ steps.vars.outputs.version }}-1-x86_64.pkg.tar.zst
            target/alpinepkg/sanitize-filenames-${{ steps.vars.outputs.version }}-r0-x86_64.apk
            target/rpm/**/*.rpm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

