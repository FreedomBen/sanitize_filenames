name: CI

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write

env:
  RUST_TOOLCHAIN: stable
  MUSL_TARGET: x86_64-unknown-linux-musl

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          targets: ${{ env.MUSL_TARGET }}

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools make gcc

      - name: Strip linuxbrew from PATH
        run: |
          CLEAN_PATH=$(printf '%s\n' "$PATH" | tr ':' '\n' | grep -v 'linuxbrew' | paste -sd: -)
          echo "PATH=$CLEAN_PATH" >> "$GITHUB_ENV"

      - name: Fetch dependencies
        run: make deps

      - name: Build (release, musl)
        run: make build

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          targets: ${{ env.MUSL_TARGET }}

      - name: Install test dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools make gcc

      - name: Strip linuxbrew from PATH
        run: |
          CLEAN_PATH=$(printf '%s\n' "$PATH" | tr ':' '\n' | grep -v 'linuxbrew' | paste -sd: -)
          echo "PATH=$CLEAN_PATH" >> "$GITHUB_ENV"

      - name: Run tests
        run: make test

  release-binary:
    name: Release binary
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          targets: ${{ env.MUSL_TARGET }}

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools make gcc

      - name: Strip linuxbrew from PATH
        run: |
          CLEAN_PATH=$(printf '%s\n' "$PATH" | tr ':' '\n' | grep -v 'linuxbrew' | paste -sd: -)
          echo "PATH=$CLEAN_PATH" >> "$GITHUB_ENV"

      - name: Build release binary (containerized)
        run: make release-binary

      - name: Extract version
        run: echo "PKG_VERSION=$(awk -F '\"' '/^version = / {print $2; exit}' Cargo.toml)" >> "$GITHUB_ENV"

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: sanitize_filenames-${{ env.PKG_VERSION }}-${{ env.MUSL_TARGET }}
          path: target/${{ env.MUSL_TARGET }}/release/sanitize_filenames

  release-rpm:
    name: Release RPM
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          targets: ${{ env.MUSL_TARGET }}

      - name: Install RPM build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools make gcc rpm

      - name: Strip linuxbrew from PATH
        run: |
          CLEAN_PATH=$(printf '%s\n' "$PATH" | tr ':' '\n' | grep -v 'linuxbrew' | paste -sd: -)
          echo "PATH=$CLEAN_PATH" >> "$GITHUB_ENV"

      - name: Build RPM (containerized)
        run: make release-rpm

      - name: Extract version
        run: echo "PKG_VERSION=$(awk -F '\"' '/^version = / {print $2; exit}' Cargo.toml)" >> "$GITHUB_ENV"

      - name: Upload RPM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sanitize-filenames-${{ env.PKG_VERSION }}-rpms
          path: target/rpm/**/*.rpm

  release-deb:
    name: Release DEB
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          targets: ${{ env.MUSL_TARGET }}

      - name: Install DEB build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools make gcc dpkg-dev

      - name: Strip linuxbrew from PATH
        run: |
          CLEAN_PATH=$(printf '%s\n' "$PATH" | tr ':' '\n' | grep -v 'linuxbrew' | paste -sd: -)
          echo "PATH=$CLEAN_PATH" >> "$GITHUB_ENV"

      - name: Build DEB (containerized)
        run: make release-deb

      - name: Extract version
        run: echo "PKG_VERSION=$(awk -F '\"' '/^version = / {print $2; exit}' Cargo.toml)" >> "$GITHUB_ENV"

      - name: Upload DEB artifact
        uses: actions/upload-artifact@v4
        with:
          name: sanitize-filenames_${{ env.PKG_VERSION }}_amd64.deb
          path: target/deb/sanitize-filenames_${{ env.PKG_VERSION }}_amd64.deb

  release-arch:
    name: Release Arch PKG
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Arch package (containerized)
        run: make release-arch

      - name: Extract version
        run: echo "PKG_VERSION=$(awk -F '\"' '/^version = / {print $2; exit}' Cargo.toml)" >> "$GITHUB_ENV"

      - name: Upload Arch artifact
        uses: actions/upload-artifact@v4
        with:
          name: sanitize-filenames-${{ env.PKG_VERSION }}-1-x86_64.pkg.tar.zst
          path: target/archpkg/sanitize-filenames-${{ env.PKG_VERSION }}-1-x86_64.pkg.tar.zst

  release-alpine:
    name: Release Alpine APK
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Alpine package (containerized)
        run: make release-alpine

      - name: Extract version
        run: echo "PKG_VERSION=$(awk -F '\"' '/^version = / {print $2; exit}' Cargo.toml)" >> "$GITHUB_ENV"

      - name: Upload Alpine artifact
        uses: actions/upload-artifact@v4
        with:
          name: sanitize-filenames-${{ env.PKG_VERSION }}-r0-x86_64.apk
          path: target/alpinepkg/sanitize-filenames-${{ env.PKG_VERSION }}-r0-x86_64.apk

  publish-release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs:
      - release-binary
      - release-rpm
      - release-deb
      - release-arch
      - release-alpine
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: vars
        run: |
          TAG_NAME="${GITHUB_REF_NAME}"
          VERSION="${TAG_NAME#v}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Build all release artifacts (containerized)
        run: |
          make release-binary
          make release-rpm
          make release-deb
          make release-arch
          make release-alpine

      - name: Prepare binary filename
        run: |
          VERSION="${{ steps.vars.outputs.version }}"
          cp "target/${{ env.MUSL_TARGET }}/release/sanitize_filenames" \
             "sanitize_filenames-${VERSION}-${{ env.MUSL_TARGET }}"

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          files: |
            sanitize_filenames-${{ steps.vars.outputs.version }}-${{ env.MUSL_TARGET }}
            target/deb/sanitize-filenames_${{ steps.vars.outputs.version }}_amd64.deb
            target/archpkg/sanitize-filenames-${{ steps.vars.outputs.version }}-1-x86_64.pkg.tar.zst
            target/alpinepkg/sanitize-filenames-${{ steps.vars.outputs.version }}-r0-x86_64.apk
            target/rpm/**/*.rpm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
